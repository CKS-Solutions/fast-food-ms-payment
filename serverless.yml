service: ms-payment
frameworkVersion: '3'

provider:
  name: aws
  runtime: go1.x
  stage: ${opt:stage, 'api'}
  region: us-east-1
  environment:
    REGION: ${self:provider.region}
    STAGE: ${self:provider.stage}
    PAYMENT_TOPIC_ARN:
      Ref: PaymentTopic

package:
  individually: true
  patterns:
    - '!./**'
    - 'bin/**'

functions:
  generatePayment:
    handler: bin/generatePayment
    memorySize: 128
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - PaymentQueue
              - Arn
          batchSize: 1

  checkPaymentStatus:
    handler: bin/checkPaymentStatus
    memorySize: 128
    events:
      - http:
          path: /v1/payment/{external_id}
          method: GET

  updatePaymentStatus:
    handler: bin/updatePaymentStatus
    memorySize: 128

  webhookOrchestratorMP:
    handler: bin/webhookOrchestratorMP
    memorySize: 128
    events:
      - http:
          path: /v1/mercadopago/webhook
          method: POST

resources:
  Resources:
    PaymentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Payments
        AttributeDefinitions:
          - AttributeName: external_id
            AttributeType: S
        KeySchema:
          - AttributeName: external_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    PaymentTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: PaymentTopic

    PaymentQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: PaymentQueue

plugins:
  - serverless-localstack

custom:
  localstack:
    stages:
      - local
    host: http://localhost
    edgePort: 4566
    lambda:
      executor: docker-reuse
    autostart: false